import { useState, useCallback, useEffect } from 'react';

export function useRideLogic({ rideId, initialDetails, ownerId, onJoin, onDelete, onTransferOwnership }) {
    // User State
    const [currentUser, setCurrentUser] = useState(null);
    const [membershipStatus, setMembershipStatus] = useState(initialDetails?.membership_status || null);

    // Data State
    const [allMembers, setAllMembers] = useState([]);
    const [rideDetailsFull, setRideDetailsFull] = useState(null);

    // Loading and Error States
    const [status, setStatus] = useState({
        ridersLoading: false, ridersError: null,
        detailsLoading: false, detailsError: null,
        actionLoading: false, actionError: null, // For join/leave
        deleteLoading: false, deleteError: null
    });

    useEffect(() => {
            try {
                const storedUser = JSON.parse(localStorage.getItem('user'));
                setCurrentUser(storedUser);
            } catch (e) {
                console.error("Error parsing user", e);
            }
        }, []);

    const isOwner = currentUser && ownerId && (currentUser.id === ownerId);

    // --- ACTIONS --- //

    // Fetch Riders
    const fetchRiders = async () => {
        if (!rideId) return;
        setStatus(prev => ({ ...prev, ridersLoading: true, ridersError: null }));
        try {
            const token = localStorage.getItem('token');
            const res = await fetch(`http://localhost:8080/api/rides/${rideId}`, {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            if (!res.ok) throw new Error('Failed to load riders');
            
            const data = await res.json();
            setAllMembers(data?.ride?.members || []);
        } catch (err) {
            setStatus(prev => ({ ...prev, ridersError: err.message}));
        } finally {
            setStatus(prev => ({ ...prev, ridersLoading: false}));
        }
    };

    // Fetch Ride Details
    const fetchRideDetails = async () => {
        if (!rideId) return;
        setStatus(prev => ({ ...prev, detailsLoading: true, detailsError: null }));

        try {
            const token = localStorage.getItem('token');
            const res = await fetch(`http://localhost:8080/api/rides/${rideId}`, {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            if (!res.ok) throw new Error('Failed to load ride details');
            
            const data = await res.json();
            setRideDetailsFull(data.ride);
        } catch (err) {
            setStatus(prev => ({ ...prev, detailsError: err.message }));
        } finally {
            setStatus(prev => ({ ...prev, detailsLoading: false }));
        }
    };

    // Handle Request
    const handleRequestAction = async (memberId, action) => {
        try {
            const token = localStorage.getItem('token');
            const res = await fetch(`http://localhost:8080/api/rides/${rideId}/${action}/${memberId}`, {
                method: 'POST', 
                headers: {
                    'content-type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }   
            });
        
            if (!res.ok) throw new Error(`Failed to ${action} member`);

            await fetchRiders(); // refresh members list
        } catch (err) {
            console.error(`Error during ${action} member:`, err);
        }
    };

    //handle Join/Leave Ride
    const handleJoinLeave = async () => {
        setStatus(prev => ({ ...prev, actionLoading: true, actionError: null }));
        const isLeaving = !!membershipStatus;
        const endpoint = isLeaving ? 'leave' : 'join';
        const method = isLeaving ? 'DELETE' : 'POST';

        try {
            if (!currentUser) throw new Error('User not authenticated');
            await apiCall(`${API_BASE}/${rideId}/${endpoint}`, method);
            
            setMembershipStatus(isLeaving ? null : 'PENDING');
            if (onJoin) await onJoin(rideId);
            return true; // Success
        } catch (err) {
            setStatus(prev => ({ ...prev, actionError: err.message }));
            return false;
        } finally {
            setStatus(prev => ({ ...prev, actionLoading: false }));
        }
    };

    // Execute Delete Ride
    const executeDelete = async () => {
        setDeleteLoading(true);
        setDeleteError(null);

        try{
            const token = localStorage.getItem('token');
            const res = await fetch(`/api/rides/${rideId}`, {
                method: 'DELETE',
                headers: {
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                }
            });
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                throw new Error(data.error || 'Failed to delete ride');
            }

            if (onDelete) onDelete(rideId);
        } catch (err){
            console.error("Delete error:", err);
            setDeleteError(err.message || 'Error deleting ride');
        } finally {
            setDeleteLoading(false);
        }
    };

}